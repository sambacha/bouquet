{"version":3,"file":"bundleUtils.js","sourceRoot":"","sources":["../../ts/library/bundleUtils.ts"],"names":[],"mappings":"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","sourcesContent":["import { providers, Signer, utils } from 'ethers'\nimport { BlockInfo, Bundle, serialize, Signers } from '../types/types.js'\nimport { EthereumAddress, EthereumData } from '../types/ethereumTypes.js'\n\nexport interface FlashbotsBundleTransaction {\n\ttransaction: providers.TransactionRequest\n\tsigner: Signer\n}\n\nexport const getMaxBaseFeeInFutureBlock = (baseFee: bigint, blocksInFuture: bigint) => {\n\tif (blocksInFuture <= 0n) throw new Error('blocksInFuture needs to be positive')\n\treturn [...Array(blocksInFuture)].reduce((accumulator, _currentValue) => (accumulator * 1125n) / 1000n, baseFee) + 1n\n}\n\nasync function getSimulatedCountsOnNetwork(provider: providers.Web3Provider): Promise<{ [address: string]: bigint }> {\n\ttry {\n\t\tconst { payload } = await provider.send(\n\t\t\t'interceptor_getSimulationStack',\n\t\t\t['1.0.0']\n\t\t)\n\t\tconst result = payload.reduce((acc: { [address: string]: bigint }, curr: { from: string }) => {\n\t\t\tcurr.from = utils.getAddress(curr.from)\n\t\t\tif (curr.from in acc) acc[curr.from] += 1n\n\t\t\telse acc[curr.from] = 1n\n\t\t\treturn acc\n\t\t}, {})\n\t\treturn result\n\t} catch (error) {\n\t\tconsole.error(\"getSimulatedCountsOnNetwork error: \", error)\n\t\treturn {}\n\t}\n}\n\nexport const signBundle = async (bundle: FlashbotsBundleTransaction[], provider: providers.Web3Provider, blockInfo: BlockInfo, maxBaseFee: bigint) => {\n\tconst transactions: string[] = []\n\tconst inSimulation = await getSimulatedCountsOnNetwork(provider)\n\tconst accNonces: { [address: string]: bigint } = {}\n\tfor (const tx of bundle) {\n\t\ttx.transaction.maxPriorityFeePerGas = blockInfo.priorityFee\n\t\ttx.transaction.maxFeePerGas = blockInfo.priorityFee + maxBaseFee\n\t\tif (!tx.transaction.from) throw new Error('BundleTransaction missing from address')\n\t\tif (!tx.transaction.chainId) throw new Error('BundleTransaction missing chainId')\n\t\t// Fetch and increment nonces from network, reduce the fetch amount by amount of transactions made on the simulation stack\n\t\tif (tx.transaction.from in accNonces) {\n\t\t\taccNonces[tx.transaction.from] += 1n\n\t\t} else {\n\t\t\taccNonces[tx.transaction.from] = BigInt(await provider.getTransactionCount(tx.transaction.from, 'latest'))\n\t\t\tif (tx.transaction.from in inSimulation) accNonces[tx.transaction.from] -= inSimulation[tx.transaction.from]\n\t\t}\n\t\ttx.transaction.nonce = accNonces[tx.transaction.from]\n\t\tconst signedTx = await tx.signer.signTransaction(tx.transaction)\n\t\ttransactions.push(signedTx as string)\n\t}\n\treturn transactions\n}\n\nexport const createBundleTransactions = async (\n\tbundle: Bundle,\n\tsigners: Signers,\n\tblockInfo: BlockInfo,\n\tblocksInFuture: bigint,\n\tfundingAmountMin: bigint,\n): Promise<FlashbotsBundleTransaction[]> => {\n\treturn await Promise.all(bundle.transactions.map(async ({ from, to, gasLimit, value, input, chainId }, index) => {\n\t\tconst gasOpts = {\n\t\t\tmaxPriorityFeePerGas: blockInfo.priorityFee,\n\t\t\ttype: 2,\n\t\t\tmaxFeePerGas: blockInfo.priorityFee + getMaxBaseFeeInFutureBlock(blockInfo.baseFee, blocksInFuture),\n\t\t}\n\t\tif (index === 0 && bundle.containsFundingTx && signers.burner) {\n\t\t\treturn {\n\t\t\t\tsigner: signers.burner,\n\t\t\t\ttransaction: {\n\t\t\t\t\tfrom: signers.burner.address,\n\t\t\t\t\t...(bundle && bundle.transactions[0].to\n\t\t\t\t\t\t? {\n\t\t\t\t\t\t\tto: utils.getAddress(serialize(EthereumAddress, bundle.transactions[0].to)),\n\t\t\t\t\t\t}\n\t\t\t\t\t\t: {}),\n\t\t\t\t\tvalue: fundingAmountMin - 21000n * (getMaxBaseFeeInFutureBlock(blockInfo.baseFee, blocksInFuture) + blockInfo.priorityFee),\n\t\t\t\t\tdata: '0x',\n\t\t\t\t\tgasLimit: 21000n,\n\t\t\t\t\tchainId: Number(chainId),\n\t\t\t\t\t...gasOpts,\n\t\t\t\t},\n\t\t\t}\n\t\t} else\n\t\t\treturn {\n\t\t\t\tsigner: signers.bundleSigners[utils.getAddress(serialize(EthereumAddress, from))],\n\t\t\t\ttransaction: {\n\t\t\t\t\tfrom: utils.getAddress(serialize(EthereumAddress, from)),\n\t\t\t\t\t...(to ? { to: utils.getAddress(serialize(EthereumAddress, to)) } : {}),\n\t\t\t\t\tgasLimit,\n\t\t\t\t\tdata: serialize(EthereumData, input),\n\t\t\t\t\tvalue,\n\t\t\t\t\tchainId: Number(chainId),\n\t\t\t\t\t...gasOpts,\n\t\t\t\t},\n\t\t\t}\n\t}))\n}\n"]}